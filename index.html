<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conversor Excel/CSV para SQL</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    html, body { height: 100vh; margin: 0; overflow: hidden; }
    .main-container { height: 100vh; display: flex; }
    .left-panel { width: 50%; display: flex; flex-direction: column; padding: 10px; overflow-y: auto; }
    #mappingContainer { flex-grow: 1; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
    .right-panel { width: 50%; display: flex; flex-direction: column; padding: 10px; }
    #output { flex-grow: 1; font-family: monospace; resize: none; overflow-y: auto; }
  </style>
</head>
<body>
  
<div class="main-container">
  <div class="left-panel">
    <h4>Conversor Excel/CSV para SQL</h4>

    <!-- Escolha de arquivo -->
    <div class="form-group">
      <label for="fileUpload">Escolha o arquivo Excel (.xlsx) ou CSV:</label>
      <input type="file" class="form-control-file" id="fileUpload" accept=".xlsx, .csv">
    </div>

    <h4>Configurações</h4>
    <div class="row mt-3">
      <div class="col-md-6 mb-2">
        <!-- Nome da Tabela -->
        <div class="form-group">
          <label for="tableName">Nome da Tabela:</label>
          <input type="text" class="form-control" id="tableName" placeholder="Digite o nome da tabela">
        </div>

        <!-- Opção de ignorar primeira linha -->
        <div class="form-check">
          <input type="checkbox" class="form-check-input" id="ignoreHeader">
          <label class="form-check-label" for="ignoreHeader">Ignorar primeira linha (cabeçalho)</label>
        </div>
      </div>

      <div class="col-md-6 mb-2">
        <!-- Escolha de SQL (INSERT ou UPDATE) -->
        <div class="form-group mt-2">
          <label>Tipo de SQL:</label><br>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="sqlType" id="insertOption" value="insert" checked>
            <label class="form-check-label" for="insertOption">INSERT</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="sqlType" id="updateOption" value="update">
            <label class="form-check-label" for="updateOption">UPDATE</label>
          </div>
        </div>
      </div>
    </div>

    <!-- Botões -->
    <div class="row mt-3">
      <div class="col-md-4 mb-2">
        <button class="btn btn-primary btn-block" onclick="generateSQL()">Gerar SQL</button>
      </div>
      <div class="col-md-4 mb-2">
        <button class="btn btn-secondary btn-block" onclick="document.getElementById('uploadConfig').click()">Carregar Configuração</button>
        <input type="file" id="uploadConfig" style="display: none" onchange="loadConfigFromFile(event)">
      </div>
      <div class="col-md-4 mb-2">
        <button class="btn btn-secondary btn-block" onclick="downloadConfig()">Baixar Configuração</button>
      </div>
    </div>

    <!-- Tabela de De-Para com nova ordem de colunas -->
    <div id="mappingContainer" class="mt-3">
      <table class="table table-bordered text-center">
        <thead class="thead-light">
          <tr>
            <th>Incluir</th>
            <th>Índice</th>
            <th>Nome do Campo</th>
            <th>Concatenação</th>
            <th>Chave</th>
          </tr>
        </thead>
        <tbody id="mappingTable"></tbody>
      </table>
    </div>
  </div>

  <div class="right-panel">
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <h4 style="margin: 0;">SQL Gerado</h4>
      <button class="btn btn-outline-secondary btn-sm" onclick="copySQL()">Copiar</button>
    </div>
    <textarea id="output" class="form-control" readonly></textarea>
  </div>
</div>

<!-- Bibliotecas -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

<script>
  // Converte número para a letra da coluna do Excel
  function numberToExcelColumn(n) {
    let result = '';
    while(n >= 0) {
      result = String.fromCharCode((n % 26) + 65) + result;
      n = Math.floor(n / 26) - 1;
    }
    return result;
  }
  
  // Junta os valores usando os separadores configurados.
  // Se o valor de um item for "null" (ignorando case e espaços), esse item é ignorado e seu separador não é usado.
  function joinWithSeparators(arr) {
    // Filtra os itens cujo valor não é "null"
    let filtered = arr.filter(item => item.value.trim().toLowerCase() !== "null");
    // Se nenhum item for válido, retorna "null"
    if (filtered.length === 0) {
      return "null";
    }
    let result = "";
    for (let i = 0; i < filtered.length; i++) {
      result += filtered[i].value;
      // Adiciona o separador apenas se houver um próximo item válido
      if (i < filtered.length - 1) {
        result += filtered[i].separator;
      }
    }
    return result;
  }
  
  // Formata o valor para SQL: se o valor concatenado for "null" (ignorando case e espaços), retorna null sem aspas.
  function formatSQLValue(val) {
    let trimmed = val.trim();
    if (trimmed.toLowerCase() === "null") {
      return "null";
    }
    return "'" + val + "'";
  }
  
  $(document).ready(function() {
    // Cria 50 linhas na tabela de mapeamento com a nova ordem de colunas
    for (let i = 0; i < 50; i++) {
      $('#mappingTable').append(`
        <tr>
          <td><input type="checkbox" class="useField"></td>
          <td>
            <input type="number" class="columnIndex" min="0" placeholder="Ex: 0" style="width:75px;">
            <span class="columnLetter" style="margin-left: 5px;"></span>
          </td>
          <td>
            <input type="text" class="fieldName" placeholder="Ex: endereco" style="width:100%;">
          </td>
          <td>
            <input type="text" class="concatSeparator" placeholder="Ex: , " style="width:120px;">
          </td>
          <td>
            <input type="checkbox" class="isKey">
          </td>
        </tr>
      `);
    }
    
    // Atualiza o label com a letra correspondente quando o índice é alterado
    $(document).on('change', '.columnIndex', function() {
      let value = parseInt($(this).val());
      let letter = isNaN(value) ? '' : numberToExcelColumn(value);
      $(this).siblings('.columnLetter').text(letter);
    });
  
    // Gera o SQL ao clicar no botão "Gerar SQL"
    window.generateSQL = function() {
      const fileInput = document.getElementById('fileUpload');
      if (!fileInput.files || fileInput.files.length === 0) {
        alert('Nenhum arquivo carregado!');
        return;
      }
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheet];
        const fileData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        const tableName = $('#tableName').val().trim();
        if (!tableName) {
          alert('Por favor, insira o nome da tabela!');
          return;
        }
        
        const ignoreHeader = $('#ignoreHeader').prop('checked');
        const sqlType = $('input[name="sqlType"]:checked').val();
        let mappings = [];
        
        // Cria o array de mapeamentos a partir das linhas da tabela
        $('#mappingTable tr').each(function() {
          const include = $(this).find('.useField').prop('checked');
          const index = parseInt($(this).find('.columnIndex').val());
          const fieldName = $(this).find('.fieldName').val().trim();
          const isKey = $(this).find('.isKey').prop('checked');
          const concatSeparator = $(this).find('.concatSeparator').val();
          
          if (include && !isNaN(index) && fieldName) {
            mappings.push({ index, fieldName, isKey, concatSeparator });
          }
        });
        
        if (mappings.length === 0) {
          alert('Nenhum campo configurado!');
          return;
        }
        
        let sqlStatements = [];
        const dataRows = ignoreHeader ? fileData.slice(1) : fileData;
        
        dataRows.forEach(row => {
          let values = {};
          let keys = [];
          
          // Agrupa os valores de cada mapeamento pelo nome do campo,
          // armazenando cada valor com seu respectivo separador.
          // Se o valor for "null" (ignorando case), ele será filtrado e não concatenado.
          mappings.forEach(({ index, fieldName, isKey, concatSeparator }) => {
            if (!values[fieldName]) {
              values[fieldName] = [];
            }
            let sanitizedValue = String(row[index]).replace(/'/g, "''");
            values[fieldName].push({ value: sanitizedValue, separator: concatSeparator });
            
            if (isKey) {
              keys.push(`${fieldName} = ${formatSQLValue(sanitizedValue)}`);
            }
          });
          
          let columns = Object.keys(values);
          let formattedValues = columns.map(col => formatSQLValue(joinWithSeparators(values[col])));
          
          if (sqlType === 'insert') {
            sqlStatements.push(`INSERT INTO ${tableName} (${columns.join(', ')}) VALUES (${formattedValues.join(', ')});`);
          } else if (sqlType === 'update' && keys.length > 0) {
            let setClause = columns.filter(col => !mappings.find(m => m.fieldName === col && m.isKey))
                                    .map(col => `${col} = ${formatSQLValue(joinWithSeparators(values[col]))}`)
                                    .join(', ');
            sqlStatements.push(`UPDATE ${tableName} SET ${setClause} WHERE ${keys.join(' AND ')};`);
          }
        });
        
        $('#output').val(sqlStatements.join('\n'));
      };
      
      reader.readAsArrayBuffer(file);
    };
    
    // Função para baixar a configuração, incluindo o valor de concatenação
    window.downloadConfig = function() {
      const tableName = $('#tableName').val().trim();
      const sanitizedTableName = tableName.replace(/[^a-zA-Z0-9_-]/g, '');
      
      const config = {
        tableName: tableName,
        ignoreHeader: $('#ignoreHeader').prop('checked'),
        insertOption: $('#insertOption').prop('checked'),
        mappings: []
      };
      
      $('#mappingTable tr').each(function() {
        const include = $(this).find('.useField').prop('checked');
        const index = parseInt($(this).find('.columnIndex').val());
        const fieldName = $(this).find('.fieldName').val().trim();
        const isKey = $(this).find('.isKey').prop('checked');
        const concatSeparator = $(this).find('.concatSeparator').val();
        
        if (include && !isNaN(index) && fieldName) {
          config.mappings.push({ index, fieldName, isKey, concatSeparator });
        }
      });
      
      const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `Config_${sanitizedTableName}.json`;
      a.click();
    };
    
    // Função para carregar a configuração, incluindo o valor de concatenação
    window.loadConfigFromFile = function(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const config = JSON.parse(e.target.result);
        
        $('#tableName').val(config.tableName);
        $('#ignoreHeader').prop('checked', config.ignoreHeader);
        $('#insertOption').prop('checked', config.insertOption ?? true);
        $('#updateOption').prop('checked', !$('#insertOption').prop('checked'));
        
        $('#mappingTable tr').each(function(index) {
          if (index < config.mappings.length) {
            $(this).find('.useField').prop('checked', true);
            $(this).find('.columnIndex').val(config.mappings[index].index).trigger('change');
            $(this).find('.fieldName').val(config.mappings[index].fieldName);
            $(this).find('.concatSeparator').val(config.mappings[index].concatSeparator);
            $(this).find('.isKey').prop('checked', config.mappings[index].isKey);
          }
        });
      };
      
      reader.readAsText(file);
    };
  });
  
  // Função para copiar o conteúdo do SQL gerado
  window.copySQL = function() {
    const sql = document.getElementById("output").value;
    if (!sql) {
      alert("Nenhum SQL gerado para copiar!");
      return;
    }
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(sql).then(() => {
        alert("SQL copiado para a área de transferência!");
      }, () => {
        alert("Erro ao copiar o SQL.");
      });
    } else {
      let textArea = document.createElement("textarea");
      textArea.value = sql;
      textArea.style.position = "fixed";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        document.execCommand("copy");
        alert("SQL copiado para a área de transferência!");
      } catch (err) {
        alert("Erro ao copiar o SQL.");
      }
      document.body.removeChild(textArea);
    }
  };
</script>

</body>
</html>
